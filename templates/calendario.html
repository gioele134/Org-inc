<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Settimana Disponibilità</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
      background-color: #f9f9f9;
    }

    header {
      padding: 10px;
      background-color: #0077cc;
      color: white;
    }

    a {
      color: white;
      text-decoration: underline;
    }

    .settimana {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 15px;
      max-width: 400px;
      margin: 0 auto;
    }

    .giorno {
      padding: 30px 10px;
      border-radius: 8px;
      color: #000;
      font-weight: bold;
      background-color: rgba(0, 128, 0, 0.1); /* verde 10% */
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .giorno.disponibilita-2 {
      background-color: rgba(255, 165, 0, 0.1); /* arancione 10% */
    }

    .giorno:hover {
      cursor: pointer;
      opacity: 0.9;
    }

    .domenica {
      grid-column: span 2;
      background-color: red !important;
      color: white;
      padding: 15px;
      height: 50px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <header>
    <h2>Disponibilità Settimanale</h2>
    <p>Benvenuto, {{ username }}</p>
    <a href="{{ url_for('logout') }}">Logout</a>
  </header>

  <div class="settimana" id="griglia">
    <!-- I 7 blocchi saranno generati da JavaScript -->
  </div>

  <script>
    const giorni = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
    const disponibilita = {};
    const oggi = new Date();
    const lunedi = new Date(oggi.setDate(oggi.getDate() - oggi.getDay() + 1));

    function formatData(date) {
      return date.toISOString().split('T')[0];
    }

    function creaGriglia() {
      const container = document.getElementById('griglia');
      container.innerHTML = '';

      for (let i = 0; i < 7; i++) {
        const giornoData = new Date(lunedi);
        giornoData.setDate(lunedi.getDate() + i);
        const dataStr = formatData(giornoData);

        const div = document.createElement('div');
        div.classList.add('giorno');
        div.textContent = `${giorni[i]} (${dataStr})`;

        if (i === 6) {
          div.classList.add('domenica');
        } else {
          if (disponibilita[dataStr] === 2) {
            div.classList.add('disponibilita-2');
          }

          div.addEventListener('click', () => {
            if (!disponibilita[dataStr]) {
              disponibilita[dataStr] = 1;
            } else if (disponibilita[dataStr] < 2) {
              disponibilita[dataStr]++;
            }

            creaGriglia(); // aggiorna grafica

            fetch('/aggiorna_disponibilita', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                data: dataStr,
                disponibilita: disponibilita[dataStr]
              })
            });
          });
        }

        container.appendChild(div);
      }
    }

    document.addEventListener('DOMContentLoaded', async function () {
      const res = await fetch('/dati_disponibilita');
      const dati = await res.json();
      Object.assign(disponibilita, dati);
      creaGriglia();
    });
  </script>
</body>
</html>
