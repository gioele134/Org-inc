<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Calendario Disponibilità</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f9f9f9;
    }

    header {
      padding: 15px;
      background-color: #0077cc;
      color: white;
      text-align: center;
    }

    a {
      color: white;
      text-decoration: underline;
    }

    .settimana {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      max-width: 400px;
      margin: 20px auto;
      gap: 0;
      border: 1px solid #ccc;
    }

    .giorno {
      padding: 25px 5px;
      border: 1px solid #ccc;
      font-weight: bold;
      background-color: white;
      box-sizing: border-box;
    }

    .giorno.disponibilita-1 {
      background-color: rgba(0, 128, 0, 0.1); /* verde 10% */
    }

    .giorno.disponibilita-2 {
      background-color: rgba(255, 165, 0, 0.1); /* arancione 10% */
    }

    .giorno.selezionato {
      background-color: rgba(0, 128, 0, 0.8); /* verde 80% */
      color: white;
    }

    .domenica {
      grid-column: span 3;
      background-color: rgba(255, 0, 0, 0.5) !important;
      color: white;
      pointer-events: none;
      text-align: center;
    }

    .navigazione, .invia {
      text-align: center;
      margin: 15px 0;
    }

    button {
      background-color: #0077cc;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      margin: 5px;
      cursor: pointer;
    }

    button:disabled {
      background-color: #aaa;
    }
  </style>
</head>
<body>
  <header>
    <h2>Calendario Disponibilità</h2>
    <p>Benvenuto, {{ username }}</p>
    <a href="{{ url_for('logout') }}">Logout</a>
  </header>

  <div class="navigazione">
    <button id="prevBtn">← Settimana precedente</button>
    <span id="titoloSettimana"></span>
    <button id="nextBtn">Settimana successiva →</button>
  </div>

  <div class="settimana" id="griglia"></div>

  <div class="invia">
    <button id="inviaBtn">Invia</button>
  </div>

  <script>
    const giorni = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
    const disponibilita = {};
    const selezioniUtente = new Set();

    const oggi = new Date();
    const lunediCorrente = new Date(oggi.setDate(oggi.getDate() - oggi.getDay() + 1));
    const primoLunedi = new Date(lunediCorrente);
    primoLunedi.setDate(primoLunedi.getDate() + 7); // esclude settimana corrente

    let settimanaIndex = 0; // da 0 a 4

    function formatData(date) {
      const giorno = String(date.getDate()).padStart(2, '0');
      return date.toISOString().split('T')[0];
    }

    function etichettaGiorno(i, data) {
      const numero = String(data.getDate()).padStart(2, '0');
      return `${giorni[i]} ${numero}`;
    }

    function getLunediSettimana(i) {
      const base = new Date(primoLunedi);
      base.setDate(base.getDate() + (i * 7));
      return base;
    }

    function creaGriglia() {
      const container = document.getElementById('griglia');
      const titolo = document.getElementById('titoloSettimana');
      container.innerHTML = '';

      const lunedi = getLunediSettimana(settimanaIndex);
      const domenica = new Date(lunedi);
      domenica.setDate(lunedi.getDate() + 6);

      titolo.textContent = `Settimana: ${formatData(lunedi)} → ${formatData(domenica)}`;

      for (let i = 0; i < 7; i++) {
        const giornoData = new Date(lunedi);
        giornoData.setDate(lunedi.getDate() + i);
        const dataStr = formatData(giornoData);

        const div = document.createElement('div');
        div.classList.add('giorno');
        div.dataset.data = dataStr;
        div.textContent = etichettaGiorno(i, giornoData);

        if (i === 6) {
          div.classList.add('domenica');
        } else {
          if (disponibilita[dataStr] === 2) {
            div.classList.add('disponibilita-2');
          } else if (disponibilita[dataStr] === 1) {
            div.classList.add('disponibilita-1');
          }

          if (selezioniUtente.has(dataStr)) {
            div.classList.add('selezionato');
          }

          div.addEventListener('click', () => {
            if (selezioniUtente.has(dataStr)) {
              selezioniUtente.delete(dataStr);
            } else {
              selezioniUtente.add(dataStr);
            }
            creaGriglia();
          });
        }

        container.appendChild(div);
      }

      document.getElementById('prevBtn').disabled = settimanaIndex === 0;
      document.getElementById('nextBtn').disabled = settimanaIndex === 4;
    }

    document.addEventListener('DOMContentLoaded', async function () {
      const res = await fetch('/dati_disponibilita');
      const dati = await res.json();
      Object.assign(disponibilita, dati);

      document.getElementById('prevBtn').addEventListener('click', () => {
        if (settimanaIndex > 0) {
          settimanaIndex--;
          creaGriglia();
        }
      });

      document.getElementById('nextBtn').addEventListener('click', () => {
        if (settimanaIndex < 4) {
          settimanaIndex++;
          creaGriglia();
        }
      });

      document.getElementById('inviaBtn').addEventListener('click', async () => {
        for (let dataStr of selezioniUtente) {
          const count = disponibilita[dataStr] || 0;
          if (count < 2) {
            disponibilita[dataStr] = count + 1;
            await fetch('/aggiorna_disponibilita', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                data: dataStr,
                disponibilita: disponibilita[dataStr]
              })
            });
          }
        }

        selezioniUtente.clear();
        creaGriglia();
        alert("Disponibilità inviate con successo.");
      });

      creaGriglia();
    });
  </script>
</body>
</html>
